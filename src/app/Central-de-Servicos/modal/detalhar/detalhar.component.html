<div class="row">
  <div class="col-2 ajuste">
    <button class="btn btn-ligth" (click)="abrirDetalhar(data)">
      <i class="fas fa-search"></i> Analisar
    </button>
  </div>
  <div class="col-10"></div>
</div>
<div class="card-box">
  <div class="card-header"><h5>Dados do Requerimento</h5></div>
  <div class="card-body">
    <table class="table">
      <tr>
        <th>Solicitante</th>
        <td>{{ getValorOuDefault(data?.nomeBeneficiario) }}</td>
      </tr>
      <tr>
        <th>CPF do Beneficiário</th>
        <td>{{ getValorOuDefault(data?.cpfBeneficiario) }}</td>
      </tr>
      <tr>
        <th>Número do Requerimento</th>
        <td>{{ getValorOuDefault(data?.numeroRequerimento) }}</td>
      </tr>
      <tr>
        <th>Data do Requerimento</th>
        <td>
          {{ getValorOuDefault(data?.dataRequerimento, "Não informada") }}
        </td>
      </tr>
      <tr>
        <th>Código do Beneficiário</th>
        <td>
          {{ getValorOuDefault(data?.codigoBeneficiario, "Não informada") }}
        </td>
      </tr>
      <tr>
        <th>Nome do Titular</th>
        <td>
          {{ getValorOuDefault(data?.nomeBeneficiario, "Não informada") }}
        </td>
      </tr>
      <tr>
        <th>CPF do Titular</th>
        <td>{{ getValorOuDefault(data?.cpfBeneficiario, "Não informada") }}</td>
      </tr>

      <tr>
        <th>Situação</th>
        <td>{{ getValorOuDefault(data?.situacao) }}</td>
      </tr>

      <tr>
        <th>Data da Situação</th>
        <td>{{ getValorOuDefault(data?.data_Situacao) }}</td>
      </tr>

      <tr>
        <th>Tipo de Serviço</th>
        <td>{{ getValorOuDefault(data?.tipoServico) }}</td>
      </tr>
      <tr>
        <th>SR</th>
        <td>{{ getValorOuDefault(data?.sr) }}</td>
      </tr>
      <tr>
        <th>UF</th>
        <td>{{ getValorOuDefault(data?.uf) }}</td>
      </tr>
      <tr>
        <th>Projeto de Assentamento</th>
        <td>{{ getValorOuDefault(data?.projetoAssentamento) }}</td>
      </tr>
    </table>

    <!-- Tabela de lote -->
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Município</th>
          <th>Projeto de Assentamento</th>
          <th>Número do Lote</th>
          <th>Data de Início da Ocupação</th>
          <th>Anexo</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>{{ getValorOuDefault(data?.municipio) }}</td>
          <td>{{ getValorOuDefault(data?.projeto) }}</td>
          <td>{{ getValorOuDefault(data?.numero_lote || data?.lote) }}</td>
          <td>{{ getValorOuDefault(data?.periodo_regularizacao) }}</td>
          <td>
            <a href="#" target="_blank">
              <mat-icon aria-hidden="false" aria-label="Anexo"
                >attach_file</mat-icon
              >
              documento.pdf
            </a>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Tabela de bloqueios -->
    <div *ngIf="data?.tipoServico === 'Desbloqueio'">
      <h3>Bloqueios</h3>

      <!-- Tabela principal (sem Observação do Bloqueio) -->
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Data do Bloqueio</th>
            <th>Bloqueio?</th>
            <th>Tipo de Subbloqueio</th>
            <th>Tipo da Transação</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let bloqueio of data?.bloqueios || []">
            <td>{{ formatarData(bloqueio?.data_bloqueio) }}</td>
            <td>{{ bloqueio?.bloqueio ? "Sim" : "Não" }}</td>
            <td>{{ getValorOuDefault(bloqueio?.descricao_sub_bloqueio) }}</td>
            <td>{{ getValorOuDefault(bloqueio?.codigo_transacao) }}</td>
          </tr>

          <tr *ngIf="!data?.bloqueios?.length">
            <td colspan="4" class="text-center text-muted">
              Nenhum bloqueio informado
            </td>
          </tr>
        </tbody>
      </table>

      <!-- ✅ Nova tabela abaixo com Observação do Bloqueio -->
      <table class="table table-bordered mt-3">
        <thead>
          <tr>
            <th>Observação do Bloqueio</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngIf="data?.bloqueios?.length">
            <td>
              <textarea class="form-control" rows="4" readonly>{{
                data.bloqueios[0]?.descricao_bloqueio
              }}</textarea>
            </td>
          </tr>
        </tbody>
      </table>

      <h3>Desbloqueios</h3>
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Justificativa</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>
              <textarea
                class="form-control"
                rows="4"
                placeholder="Aqui consta o motivo do desbloqueio..."
                readonly
              ></textarea>
            </td>
          </tr>
        </tbody>
      </table>
      <div class="row">
        <!--<div class="col-2">
          <button type="button" class="btn btn-primary">Salvar</button>
        </div>-->
        <div class="col-10"></div>
      </div>
    </div>

    <!-- Unidade familiar -->
    <div *ngIf="data?.tipoServico === 'Altualização de unidade familiar'">
      <h3>Atualização de Unidade Familiar</h3>
      <table class="table table-striped">
        <thead>
          <tr>
            <th>CPF do Titular</th>
            <th>Nome do Titular</th>
            <th>CPF do Cônjuge</th>
            <th>Nome do Cônjuge/Companheiro(a)</th>
            <th>Situação Conjugal</th>
            <th>Data da União</th>
            <th>Envio de arquivo comprovante</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngIf="data?.dependentes?.length > 0; else semDependente">
            <td>{{ data?.cpf_T1 }}</td>
            <td>{{ data?.nome_T1 }}</td>
            <td>{{ data?.cpf_conjuge }}</td>
            <td>{{ data?.nome_T2 }}</td>
            <td>
              {{ data?.dependentes[0]?.situacao_conjugal || "Não informado" }}
            </td>
            <td>
              {{
                data?.dependentes[0]?.data_uniao
                  ? (data?.dependentes[0]?.data_uniao | date : "dd/MM/yyyy")
                  : "Não informado"
              }}
            </td>
            <td>
              <mat-icon>attach_file</mat-icon>
              <a href="#">comprovante.pdf</a>
            </td>
          </tr>
        </tbody>
        <ng-template #semDependente>
          <tr>
            <td colspan="7" class="text-center text-muted">
              Nenhum dependente informado
            </td>
          </tr>
        </ng-template>
      </table>
      <ng-template #semDependente>
        <tr>
          <td colspan="7" class="text-center text-muted">
            Nenhum dependente informado
          </td>
        </tr>
      </ng-template>
    </div>

    <div *ngIf="data?.tipoServico === 'Atualização de situação'">
      <h3>Atualização de Situação</h3>
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Data da Situação</th>
            <th>Motivo</th>
            <th>Declaração de Desistência</th>
          </tr>
        </thead>
        <tbody>
          <!-- Se houver histórico -->
          <ng-container
            *ngIf="data?.historico_PNRA?.length > 0; else semSituacao"
          >
            <tr *ngFor="let h of data.historico_PNRA; let i = index">
              <!-- Coluna Data -->
              <td>
                {{ h.data_Situacao || "Não informado" }}
              </td>

              <!-- Coluna Motivo -->
              <td>
                <mat-form-field appearance="fill" class="w-100">
                  <mat-label>Motivo</mat-label>
                  <mat-select [(value)]="h.motivo_situacao">
                    <mat-option *ngFor="let motivo of motivos" [value]="motivo">
                      {{ motivo }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>
              </td>

              <!-- Coluna Declaração de Desistência -->
              <td class="text-center">
                <!-- Se já existir uma declaração vinculada no JSON -->
                <span *ngIf="h.declaracao_desistencia; else naoAssinada">
                  {{ h.declaracao_desistencia }}
                </span>
                <ng-template #naoAssinada>
                  <span class="text-muted">Não assinada</span>
                </ng-template>
              </td>

              <!-- Coluna Ações -->
              <td class="text-center">
                <button
                  mat-raised-button
                  color="primary"
                  (click)="assinarDeclaracao(data, h, i)"
                >
                  <mat-icon class="me-1">edit_document</mat-icon>
                  Assinar
                </button>
              </td>
            </tr>
          </ng-container>

          <!-- Template caso não haja histórico -->
          <ng-template #semSituacao>
            <tr>
              <td colspan="4" class="text-center text-muted">
                Nenhuma situação informada
              </td>
            </tr>
          </ng-template>
        </tbody>
      </table>
    </div>

    <!-- Atualizar dados pessoais -->
    <div *ngIf="data?.tipoServico === 'Atualização de dados pessoais'">
      <h3>Atualizar dados pessoais</h3>
      <table class="table table-striped">
        <thead>
          <tr>
            <th>CPF do Beneficiário</th>
            <th>Nome do Beneficiário</th>
            <th>Data de nascimento</th>
            <th>Naturalidade</th>
            <th>Nome da mãe</th>
            <th>Telefone</th>
            <th>E-mail</th>
            <th>Endereço</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>{{ getValorOuDefault(data?.cpf_T1) }}</td>
            <td>{{ getValorOuDefault(data?.nome_T1) }}</td>
            <td>{{ getValorOuDefault(data?.data_nascimento) }}</td>
            <td>{{ getValorOuDefault(data?.naturalidade) }}</td>
            <td>{{ getValorOuDefault(data?.nome_mae) }}</td>
            <td>{{ getValorOuDefault(data?.telefone) }}</td>
            <td>{{ getValorOuDefault(data?.email) }}</td>
            <td>
              {{ getValorOuDefault(data?.municipio) }} -
              {{ getValorOuDefault(data?.estados) }}
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Alterar situação do Assentamento -->

    <div *ngIf="data?.tipoServico === 'Transferencia de Assentamento'">
      <!--<h3>Alterar situação do Assentamento</h3>-->
      <h3>Transferência de Assentamento</h3>
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Município</th>
            <th>Projeto de Assentamento</th>
            <th>Número do Lote</th>
            <th>Data de Início da Ocupação</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>{{ getValorOuDefault(data?.municipio) }}</td>
            <td>{{ getValorOuDefault(data?.projeto) }}</td>
            <td>{{ getValorOuDefault(data?.numero_lote) }}</td>
            <td>{{ getValorOuDefault(data?.periodo_regularizacao) }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="row">
    <div class="col-10"></div>
    <div class="col-2">
      <button class="btn btn-primary" (click)="fechar()">Voltar</button>
    </div>
  </div>
</div>
